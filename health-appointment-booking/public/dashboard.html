<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Health Appointment Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: url('https://images.pexels.com/photos/1170976/pexels-photo-1170976.jpeg?auto=compress&cs=tinysrgb&dpr=2&h=750&w=1260') no-repeat center center fixed;
      background-size: cover;
    }
    .overlay {
      background-color: rgba(0,0,0,0.6);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <div class="overlay fixed inset-0 z-0"></div>
  <header class="relative z-10 bg-white bg-opacity-90 shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">My Appointments</h1>
    <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
      Logout <i class="fas fa-sign-out-alt ml-2"></i>
    </button>
  </header>
  <main class="relative z-10 flex-grow p-6 max-w-4xl mx-auto w-full">
    <button id="addAppointmentBtn" class="mb-6 bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 transition">
      Add Appointment <i class="fas fa-plus ml-2"></i>
    </button>
    <div id="appointmentsList" class="space-y-4"></div>
  </main>

  <!-- Modal -->
  <div id="appointmentModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-20">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
      <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Appointment</h2>
      <form id="appointmentForm" class="space-y-4">
        <div>
          <label for="date" class="block font-semibold text-gray-700 mb-1">Date</label>
          <input type="date" id="date" name="date" required class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="time" class="block font-semibold text-gray-700 mb-1">Time</label>
          <input type="time" id="time" name="time" required class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="doctor" class="block font-semibold text-gray-700 mb-1">Doctor</label>
          <input type="text" id="doctor" name="doctor" required class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label for="description" class="block font-semibold text-gray-700 mb-1">Description</label>
          <textarea id="description" name="description" rows="3" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" id="cancelBtn" class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100 transition">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    const appointmentsList = document.getElementById('appointmentsList');
    const appointmentModal = document.getElementById('appointmentModal');
    const appointmentForm = document.getElementById('appointmentForm');
    const modalTitle = document.getElementById('modalTitle');
    const addAppointmentBtn = document.getElementById('addAppointmentBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    let editingAppointmentId = null;

    async function fetchAppointments() {
      try {
        const res = await fetch('http://localhost:5000/api/appointments', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();
        if (res.ok) {
          renderAppointments(data);
        } else {
          alert(data.message || 'Failed to load appointments');
          if (res.status === 401) {
            logout();
          }
        }
      } catch (err) {
        alert('Error fetching appointments');
      }
    }

    function renderAppointments(appointments) {
      appointmentsList.innerHTML = '';
      if (appointments.length === 0) {
        appointmentsList.innerHTML = '<p class="text-gray-200">No appointments found.</p>';
        return;
      }
      appointments.forEach(app => {
        const div = document.createElement('div');
        div.className = 'bg-white bg-opacity-90 rounded p-4 shadow flex justify-between items-center';
        div.innerHTML = `
          <div>
            <p><strong>Date:</strong> ${new Date(app.date).toLocaleDateString()}</p>
            <p><strong>Time:</strong> ${app.time}</p>
            <p><strong>Doctor:</strong> ${app.doctor}</p>
            <p><strong>Description:</strong> ${app.description || '-'}</p>
          </div>
          <div class="space-x-2">
            <button class="editBtn bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded" data-id="${app._id}"><i class="fas fa-edit"></i></button>
            <button class="deleteBtn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" data-id="${app._id}"><i class="fas fa-trash"></i></button>
          </div>
        `;
        appointmentsList.appendChild(div);
      });

      document.querySelectorAll('.editBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          openEditModal(id);
        });
      });

      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          deleteAppointment(id);
        });
      });
    }

    function openEditModal(id) {
      editingAppointmentId = id;
      modalTitle.textContent = 'Edit Appointment';
      fetch(`http://localhost:5000/api/appointments/${id}`, {
        headers: { Authorization: 'Bearer ' + token }
      })
      .then(res => res.json())
      .then(data => {
        if (data._id) {
          appointmentForm.date.value = new Date(data.date).toISOString().split('T')[0];
          appointmentForm.time.value = data.time;
          appointmentForm.doctor.value = data.doctor;
          appointmentForm.description.value = data.description || '';
          appointmentModal.classList.remove('hidden');
        } else {
          alert(data.message || 'Failed to load appointment');
        }
      });
    }

    function openAddModal() {
      editingAppointmentId = null;
      modalTitle.textContent = 'Add Appointment';
      appointmentForm.reset();
      appointmentModal.classList.remove('hidden');
    }

    async function deleteAppointment(id) {
      if (!confirm('Are you sure you want to delete this appointment?')) return;
      try {
        const res = await fetch(`http://localhost:5000/api/appointments/${id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();
        if (res.ok) {
          fetchAppointments();
        } else {
          alert(data.message || 'Failed to delete appointment');
        }
      } catch (err) {
        alert('Error deleting appointment');
      }
    }

    appointmentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = {
        date: appointmentForm.date.value,
        time: appointmentForm.time.value,
        doctor: appointmentForm.doctor.value,
        description: appointmentForm.description.value,
      };
      try {
        let res;
        if (editingAppointmentId) {
          res = await fetch(`http://localhost:5000/api/appointments/${editingAppointmentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(formData),
          });
        } else {
          res = await fetch('http://localhost:5000/api/appointments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
            body: JSON.stringify(formData),
          });
        }
        const data = await res.json();
        if (res.ok) {
          appointmentModal.classList.add('hidden');
          fetchAppointments();
        } else {
          alert(data.message || 'Failed to save appointment');
        }
      } catch (err) {
        alert('Error saving appointment');
      }
    });

    cancelBtn.addEventListener('click', () => {
      appointmentModal.classList.add('hidden');
    });

    addAppointmentBtn.addEventListener('click', openAddModal);

    logoutBtn.addEventListener('click', () => {
      logout();
    });

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    fetchAppointments();
  </script>
</body>
</html>
